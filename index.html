<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mars + Bianca — RSVP</title>

  <script>
    // Mark embedded and provide --dvh (dynamic viewport) support for mobile address-bar reflows
    try {
      if (window.self !== window.top) document.documentElement.setAttribute('data-embedded', 'true');
    } catch (e) {}
  </script>

  <style>
    :root {
      --bg: #fff;
      --muted: #666;
      --accent: #222;
      --danger: #c0392b;
      --card-radius: 0.6rem;
      --content-max: 42rem;
      /* --dvh will be set by JS to 1% of the dynamic viewport height */
    }

    /* Basic page reset and font */
    html, body {
      height: 100%;
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      color: #111;
      background: var(--bg);
    }

    /* Page wrap uses dynamic viewport so centering works with mobile address bars */
    .page-wrap {
      min-height: calc(var(--dvh, 1vh) * 100);
      display: flex;
      align-items: center;    /* vertical centering */
      justify-content: center;/* horizontal centering */
      padding: 3.5vw 2vw;
      box-sizing: border-box;
    }

    /* Card: center its content and allow shrinking on small content */
    .app-box {
      width: 100%;
      max-width: var(--content-max);
      background: #fff;
      border-radius: var(--card-radius);
      box-shadow: 0 0.5rem 1.5rem rgba(0,0,0,0.12);
      padding: 0.9rem;
      box-sizing: border-box;
      margin: 0 auto;

      display: flex;
      align-items: center;     /* vertically center content-column */
      justify-content: center; /* horizontally center content-column */
      min-height: 0;           /* allow shrinking when content is small */
      position: relative;
    }

    /* Embedded (when in iframe) remove outer card chrome */
    :root[data-embedded="true"] .app-box {
      background: transparent;
      box-shadow: none;
      border-radius: 0;
      padding: 0.7rem;
      max-width: 100%;
    }

    /* Content column centers the active step vertically */
    .content-column {
      width: 100%;
      max-width: 40rem;
      margin: 0 auto;
      padding: 0.4rem 0.6rem;
      text-align: center;

      display: flex;
      flex-direction: column;
      justify-content: center; /* vertical centering of active step content */
      align-items: stretch;    /* inputs stretch to full width */
      box-sizing: border-box;
    }

    /* Steps: hide by default, display active step as a centered flex column */
    .step { display: none; }
    .step.active {
      display: flex;
      flex-direction: column;
      justify-content: center; /* centers content vertically inside step */
      align-items: stretch;
      box-sizing: border-box;
      /* increased small-screen minimum so the modal doesn't feel too short on mobile */
      min-height: calc(var(--dvh, 1vh) * 30);
    }

    /* Desktop/tablet tweaks for step minimum */
    @media (min-width:641px) {
      .step.active { min-height: 18rem; } /* slightly larger minimum on larger screens */
    }

    /* Preserve your visual styles (inputs, buttons, messages, etc.) */
    h1 { margin:0; font-size:1.05rem; }
    .subhead { color:var(--muted); margin-top:0.4rem; margin-bottom:0.6rem; line-height:1.05; font-size:0.95rem; }
    .prompt { color:var(--muted); margin-bottom:0.6rem; text-align:center; display:block; font-size:0.95rem; }
    .search-row { display:flex; gap:0.5rem; margin-bottom:0.25rem; justify-content:center; }
    .search-row input { flex:1; max-width:24rem; padding:0.45rem; border:1px solid #e5e5e5; border-radius:0.5rem; font-size:0.95rem; }
    .actions { display:flex; gap:0.5rem; margin-top:0.9rem; justify-content:center; align-items:center; padding-bottom:0.6rem; }
    .actions-right { display:flex; gap:0.5rem; }
    .btn { padding:0.45rem 0.75rem; border-radius:0.5rem; border:0; cursor:pointer; font-size:0.95rem; }
    .btn.primary { background:var(--accent); color:#fff; }
    .btn.ghost { background:#f3f3f3; color:#111; }
    .error { color:var(--danger); font-size:0.92rem; margin-top:0.4rem; display:none; text-align:center; }
    .matches { margin:0 auto 0.6rem; display:flex; flex-direction:column; gap:0.4rem; align-items:center; }
    .match-btn { display:block; width:100%; max-width:28.75rem; padding:0.6rem; border:1px solid #f0f0f0; border-radius:0.5rem; background:#fff; cursor:pointer; text-align:center; transition:all .12s; font-size:0.95rem; }
    .match-btn:hover { background:#fafafa; transform:translateY(-2px); }
    .form-row { display:flex; flex-direction:column; gap:0.25rem; margin-bottom:0.6rem; align-items:center; }
    label { font-size:0.95rem; color:#333; text-align:left; width:100%; max-width:28.75rem; display:block; }
    select,input,textarea { padding:0.5rem; font-size:0.95rem; border:1px solid #e6e6e6; border-radius:0.5rem; width:100%; max-width:28.75rem; box-sizing:border-box; }
    textarea { min-height:5rem; resize:vertical; }
    .message { padding:0.5rem; background:#e7f7e7; border:1px solid #bfe6bf; border-radius:0.5rem; margin:0.4rem 0; text-align:center; }
    .small { font-size:0.88rem; color:var(--muted); margin-top:0.4rem; }
    .loading-overlay { position:absolute; inset:0; display:none; align-items:center; justify-content:center; background:rgba(255,255,255,0.7); border-radius:inherit; z-index:999; }
    .spinner { width:1.9rem; height:1.9rem; border-radius:50%; border:0.25rem solid #eee; border-top-color:var(--accent); animation:spin 1s linear infinite; }
    @keyframes spin { to { transform:rotate(360deg); } }

    /* When content grows taller than viewport, allow natural scrolling inside the iframe/page */
    @media (max-width:540px) {
      .content-column { padding:0.4rem 0.6rem; }
      .match-btn { max-width:100%; }
      label, select, input, textarea { max-width:100%; }
    }

    input[type=tel]{ font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,"Roboto Mono",monospace; }
  </style>
</head>
<body>
  <div class="page-wrap">
    <div class="app-box" id="appBox" role="dialog" aria-modal="true">
      <div id="loading" class="loading-overlay"><div class="spinner" aria-hidden="true"></div></div>

      <div class="content-column">

        <!-- Non-sticky header (reverted) -->
        <h1>Mars + Bianca</h1>
        <div class="subhead">Nuuk Taal<br>October 15, 2027</div>

        <!-- Steps -->
        <div id="step-search" class="step active">
          <span class="prompt">Please enter the name shown on your invitation to find your RSVP record.</span>
          <div class="search-row">
            <input id="nameInput" placeholder="Type your name" autocomplete="name" />
          </div>
          <div id="searchErr" class="error" aria-live="polite"></div>
          <div class="actions">
            <div class="actions-right"><button id="findBtn" class="btn primary">Find</button></div>
          </div>
        </div>

        <div id="step-matches" class="step">
          <span class="prompt">We found matching names — please select your name below to continue.</span>
          <div id="matches" class="matches" aria-live="polite"></div>
          <div class="actions">
            <button id="dontSeeBtn" class="btn ghost">I don't see my name</button>
            <div class="actions-right"><button id="backToSearch" class="btn ghost">Back</button></div>
          </div>
        </div>

        <div id="step-not-in-list" class="step">
          <span class="prompt">If your name isn't listed here, please contact us and we'll confirm your invitation status.</span>
          <div class="message"><strong>Can't find your name?</strong><div class="small" style="margin-top:.4rem">Contact: +1 778 977 4975 (WhatsApp / Viber)</div></div>
          <div class="actions">
            <button id="notInListBack" class="btn ghost">Back</button>
            <div class="actions-right"><button id="notInListClose" class="btn primary">Close</button></div>
          </div>
        </div>

        <div id="step-attendance" class="step">
          <span class="prompt">Please tell us whether you will join us for the celebration.</span>
          <div class="form-row">
            <label for="attendanceSelect">Will you be joining us?</label>
            <select id="attendanceSelect"><option value="">-- choose --</option><option value="Attending">Yes — I/we will attend</option><option value="Declined">Regretfully decline</option></select>
          </div>
          <div id="attendanceDynamic" style="margin-top:.4rem"></div>
          <div id="attendeeError" class="error"></div>
          <div class="actions">
            <button id="attendanceBack" class="btn ghost">Back</button>
            <div class="actions-right"><button id="attendanceNext" class="btn primary">Next</button></div>
          </div>
        </div>

        <div id="step-transport" class="step">
          <span class="prompt">We offer airport transfer from NAIA to Club Balai Isabel. Please let us know if you need it.</span>
          <div class="form-row">
            <label for="transportSelect">Do you need airport transfer from NAIA to Club Balai Isabel (Batangas)?</label>
            <select id="transportSelect"><option value="">-- choose --</option><option value="Yes">Yes — I/We need airport transfer</option><option value="No">No — we don't need airport transfer</option></select>
          </div>
          <div class="actions">
            <button id="transportBack" class="btn ghost">Back</button>
            <div class="actions-right"><button id="transportNext" class="btn primary">Next</button></div>
          </div>
        </div>

        <div id="step-phone" class="step">
          <span class="prompt">Please give the best Philippine mobile number where we can reach you if needed.</span>
          <div class="form-row">
            <label for="phoneInput">Phone (PH format)</label>
            <input id="phoneInput" type="tel" placeholder="09" />
            <div id="phoneErr" class="error"></div>
          </div>
          <div class="actions">
            <button id="phoneBack" class="btn ghost">Back</button>
            <div class="actions-right"><button id="phoneNext" class="btn primary">Next</button></div>
          </div>
        </div>

        <div id="step-notes" class="step">
          <span class="prompt">Optional — share dietary restrictions, song requests, or a short message.</span>
          <div class="form-row">
            <label for="notesInput">Notes (optional — dietary, song requests)</label>
            <textarea id="notesInput" placeholder="E.g. vegetarian, song request..."></textarea>
          </div>
          <div class="actions">
            <button id="notesBack" class="btn ghost">Back</button>
            <div class="actions-right"><button id="notesNext" class="btn primary">Review</button></div>
          </div>
        </div>

        <div id="step-review" class="step">
          <span class="prompt">Please review your RSVP details before submitting.</span>
          <div id="reviewSummary" class="form-row" style="text-align:left"></div>
          <div id="reviewError" class="error" style="text-align:center"></div>
          <div class="actions">
            <button id="reviewBack" class="btn ghost">Back</button>
            <div class="actions-right"><button id="submitBtn" class="btn primary">Submit RSVP</button></div>
          </div>
        </div>

        <div id="step-thanks" class="step">
          <span class="prompt">Thank you — your response is recorded.</span>
          <div id="thanksMessage" class="message" style="text-align:center"></div>
          <div class="actions">
            <div class="actions-right"><button id="thanksClose" class="btn primary">Close</button></div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <script>
  (function () {
    const API_URL = "https://rsvp-proxy.marsnbianca.workers.dev/"; // <-- replace with your Worker URL

    // set --dvh on the child side too (helps parent and content sizing on mobile)
    function updateDvh() {
      try {
        const dv = window.innerHeight * 0.01;
        document.documentElement.style.setProperty('--dvh', dv + 'px');
      } catch (_) {}
    }
    updateDvh();
    window.addEventListener('resize', updateDvh);
    window.addEventListener('orientationchange', updateDvh);
    if (window.visualViewport) {
      try {
        window.visualViewport.addEventListener('resize', updateDvh);
        window.visualViewport.addEventListener('scroll', updateDvh);
      } catch (_) {}
    }

    const steps = {
      search: document.getElementById('step-search'),
      matches: document.getElementById('step-matches'),
      notInList: document.getElementById('step-not-in-list'),
      attendance: document.getElementById('step-attendance'),
      transport: document.getElementById('step-transport'),
      phone: document.getElementById('step-phone'),
      notes: document.getElementById('step-notes'),
      review: document.getElementById('step-review'),
      thanks: document.getElementById('step-thanks')
    };

    // refs
    const nameInput = document.getElementById('nameInput');
    const findBtn = document.getElementById('findBtn');
    const searchErr = document.getElementById('searchErr');
    const matchesEl = document.getElementById('matches');

    const dontSeeBtn = document.getElementById('dontSeeBtn');
    const backToSearch = document.getElementById('backToSearch');

    const attendanceSelect = document.getElementById('attendanceSelect');
    const attendanceDynamic = document.getElementById('attendanceDynamic');
    const attendeeError = document.getElementById('attendeeError');
    const attendanceBack = document.getElementById('attendanceBack');
    const attendanceNext = document.getElementById('attendanceNext');

    const transportSelect = document.getElementById('transportSelect');
    const transportBack = document.getElementById('transportBack');
    const transportNext = document.getElementById('transportNext');

    const phoneInput = document.getElementById('phoneInput');
    const phoneErr = document.getElementById('phoneErr');
    const phoneBack = document.getElementById('phoneBack');
    const phoneNext = document.getElementById('phoneNext');

    const notesInput = document.getElementById('notesInput');
    const notesBack = document.getElementById('notesBack');
    const notesNext = document.getElementById('notesNext');

    const reviewSummary = document.getElementById('reviewSummary');
    const reviewError = document.getElementById('reviewError');
    const reviewBack = document.getElementById('reviewBack');
    const submitBtn = document.getElementById('submitBtn');

    const thanksMessage = document.getElementById('thanksMessage');
    const thanksClose = document.getElementById('thanksClose');

    const notInListBack = document.getElementById('notInListBack');
    const notInListClose = document.getElementById('notInListClose');

    const loadingOverlay = document.getElementById('loading');

    let currentInvite = null, currentMaxSeats = 1, selectedStatus = "", selectedNumber = 1, selectedAttendees = [], selectedTransport = "", selectedPhoneStored = "", selectedNotes = "";

    // showStep now toggles 'active' class so CSS can center steps reliably
    function showStep(name) {
      // restore the matches-screen action buttons by default (they may have been hidden for locked flow)
      try {
        if (dontSeeBtn) dontSeeBtn.style.display = '';
        if (backToSearch) backToSearch.style.display = '';
      } catch (_) {}

      Object.values(steps).forEach(function(s) {
        if (!s) return;
        s.classList.remove('active');
        s.style.display = ''; // clear inline display to let CSS control visibility
      });
      if (steps[name]) {
        steps[name].classList.add('active');
        steps[name].style.display = ''; // ensure no inline blocking display
      }
      const stepsWithBottomClose = new Set(['notInList','thanks']);
      notifyParentHasBottomClose(name, stepsWithBottomClose.has(name));
      setTimeout(function() { focusFirstControl(name); postHeight(); }, 80);
    }

    function focusFirstControl(stepName){
      try {
        const step = steps[stepName];
        if(!step) return;
        const first = step.querySelector('input,select,button,textarea');
        if(first) first.focus();
      } catch(_) {}
    }

    function setError(el, msg){ if(!el) return; if(msg){ el.textContent = msg; el.style.display = 'block'; } else { el.textContent = ''; el.style.display = 'none'; } }
    function loading(on){ loadingOverlay.style.display = on ? 'flex' : 'none'; }

    async function jsonFetch(payload){
      loading(true);
      try {
        const res = await fetch(API_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        const txt = await res.text();
        try { return JSON.parse(txt); } catch(e){ return { ok:false, error:'Invalid server response' }; }
      } catch(err){ console.error(err); return { ok:false, error:'Network error' }; } finally { loading(false); }
    }

    function titleCaseName(s){ s=String(s||'').replace(/\s+/g,' ').trim().toLowerCase(); if(!s) return ''; return s.split(/([\s\-'])/).map(p=> /[\s\-']/.test(p)?p: p.charAt(0).toUpperCase()+p.slice(1)).join(''); }
    function formatPhoneInput(v){ var d=String(v||'').replace(/\D+/g,''); if(d.indexOf('63')===0 && d.length>=12) d='0'+d.slice(2); if(d.indexOf('9')===0 && d.length===10) d='0'+d; d=d.slice(0,11); if(d.length<=2) return d; if(d.length<=4) return d.slice(0,4); if(d.length<=7) return d.slice(0,4)+' '+d.slice(4); return d.slice(0,4)+' '+d.slice(4,7)+' '+d.slice(7,11); }
    function normalizePhoneToStored(input){ var d=String(input||'').replace(/\D+/g,''); if(!d) return ''; if(d.indexOf('63')===0 && d.length>=12) d='0'+d.slice(2); if(d.indexOf('9')===0 && d.length===10) d='0'+d; d=d.slice(0,11); if(!/^09\d{9}$/.test(d)) return ''; return d.slice(0,4)+' '+d.slice(4,7)+' '+d.slice(7,11); }

    function notifyParentHasBottomClose(stepName, hasBottom) { try { window.parent.postMessage({ type:'RSVP:HAS_BOTTOM_CLOSE', hasBottomClose: !!hasBottom }, '*'); } catch(_) {} }

    var postTimer = null;
    function postHeight() {
      try {
        if (postTimer) clearTimeout(postTimer);
        postTimer = setTimeout(function(){
          try {
            var h = document.documentElement.scrollHeight || document.body.scrollHeight;
            window.parent.postMessage({ type:'RSVP:HEIGHT', height: h }, '*');
          } catch(e) {}
        }, 80);
      } catch(e){}
    }

    // Search
    async function doFind(){
      setError(searchErr,''); matchesEl.innerHTML = '';
      const q = (nameInput.value||'').trim();
      if(!q || q.length < 3){ setError(searchErr, 'Please type at least 3 characters.'); postHeight(); return; }
      findBtn.disabled = true;
      const r = await jsonFetch({ action:'find', name: q, client_id: 'guest-'+Date.now() });
      findBtn.disabled = false;
      if(!r || !r.ok){ setError(searchErr, r && r.error ? r.error : 'Server error'); postHeight(); return; }
      if(!r.matches || r.matches.length === 0){ setError(searchErr, 'No matches found. Please try again.'); postHeight(); return; }
      matchesEl.innerHTML = '';
      r.matches.forEach(m=>{
        const btn = document.createElement('button'); btn.type='button'; btn.className='match-btn';
        btn.innerHTML = "<div><strong>"+escapeHtml(m.display_name)+"</strong></div>";
        btn.addEventListener('click', ()=> selectInvite(m));
        matchesEl.appendChild(btn);
      });
      showStep('matches');
    }

    // wire matches controls
    if (dontSeeBtn) dontSeeBtn.addEventListener('click', ()=> showStep('notInList'));
    if (backToSearch) backToSearch.addEventListener('click', ()=> showStep('search'));

    // FIX: ensure notInList Back button works
    if (notInListBack) {
      notInListBack.addEventListener('click', function(){
        showStep('matches');
      });
    }

    async function selectInvite(m){
      setError(searchErr,'');
      const r = await jsonFetch({ action:'get', invite_id: m.invite_id });
      if(!r || !r.ok){ setError(searchErr, r && r.error ? r.error : 'Server error'); postHeight(); return; }

      if(r.locked){
        // show locked message and ONLY bottom Close
        matchesEl.innerHTML = "<div class='message'>This invitation has already been answered.</div>";
        const wrapper = document.createElement('div'); wrapper.style.marginTop='0.6rem'; wrapper.style.display='flex'; wrapper.style.justifyContent='center';
        const closeBtn = document.createElement('button'); closeBtn.className='btn primary'; closeBtn.textContent='Close';
        closeBtn.addEventListener('click', function(){ try{ window.parent.postMessage({ type:'RSVP:CLOSE' }, '*'); }catch(_){} try{ window.close(); }catch(_){} });
        wrapper.appendChild(closeBtn);
        matchesEl.appendChild(wrapper);

        // Hide the "I don't see my name" and "Back" buttons for this locked view
        try {
          if (dontSeeBtn) dontSeeBtn.style.display = 'none';
          if (backToSearch) backToSearch.style.display = 'none';
        } catch(_) {}

        notifyParentHasBottomClose('matches', true);
        postHeight();
        return;
      }

      currentInvite = r.invite || m;
      currentInvite.invite_id = m.invite_id;
      currentMaxSeats = Math.min(currentInvite.max_seats ? parseInt(currentInvite.max_seats,10) : (m.max_seats || 1), 4);
      selectedStatus=''; selectedNumber=1; selectedAttendees=[]; selectedTransport=''; selectedPhoneStored=''; selectedNotes='';
      attendanceSelect.value=''; attendanceDynamic.innerHTML=''; setError(attendeeError,'');
      notifyParentHasBottomClose('attendance', false);
      showStep('attendance');
    }

    // Attendance
    attendanceBack.addEventListener('click', ()=> showStep('matches'));

    attendanceSelect.addEventListener('change', function(){
      setError(attendeeError,''); attendanceDynamic.innerHTML = '';
      const v=(attendanceSelect.value||'').trim();
      if(v === 'Attending'){
        if(currentMaxSeats <= 1){ postHeight(); return; }
        const row=document.createElement('div'); row.className = 'form-row';
        const lbl=document.createElement('label'); lbl.textContent='How many people are attending (including you)?';
        const sel=document.createElement('select'); sel.id='numSelect';
        const placeholder=document.createElement('option'); placeholder.value=''; placeholder.textContent='-- choose --'; sel.appendChild(placeholder);
        for(let i=1;i<=currentMaxSeats;i++){ const opt=document.createElement('option'); opt.value=String(i); opt.textContent=String(i); sel.appendChild(opt); }
        sel.value=''; sel.addEventListener('change', ()=> renderGuestInputs(parseInt(sel.value,10) || 0));
        row.appendChild(lbl); row.appendChild(sel); attendanceDynamic.appendChild(row);
        const gdiv=document.createElement('div'); gdiv.id='guestInputs'; gdiv.style.marginTop='0.5rem'; attendanceDynamic.appendChild(gdiv);
        postHeight();
      } else { attendanceDynamic.innerHTML=''; postHeight(); }
    });

    function renderGuestInputs(n){
      const gdiv=document.getElementById('guestInputs'); if(!gdiv) return; gdiv.innerHTML=''; if(!n || n<1){ postHeight(); return; }
      for(let i=0;i<n;i++){ const input=document.createElement('input'); input.type='text'; input.placeholder='Guest full name'; input.className='guest-name-input'; input.style.marginBottom='0.5rem'; gdiv.appendChild(input); }
      selectedNumber = n; postHeight();
    }

    attendanceNext.addEventListener('click', function(){
      setError(attendeeError,'');
      const val=(attendanceSelect.value||'').trim();
      if(!val){ setError(attendeeError,'Please choose whether you will attend or decline.'); postHeight(); return; }
      selectedStatus = val;
      if(selectedStatus === 'Declined'){ selectedAttendees = []; buildReview(); showStep('review'); return; }
      if(currentMaxSeats <= 1){ selectedAttendees = []; showStep('transport'); return; }
      const sel = document.getElementById('numSelect');
      if(!sel || !sel.value){ setError(attendeeError,'Please choose how many people are attending.'); postHeight(); return; }
      const gdiv=document.getElementById('guestInputs'); if(!gdiv){ setError(attendeeError,'Please choose how many people are attending.'); postHeight(); return; }
      const inputs = Array.from(gdiv.querySelectorAll('.guest-name-input'));
      const names = inputs.map(i=>i.value.trim()).filter(Boolean);
      if(names.length < parseInt(sel.value,10)){ setError(attendeeError,'Please fill all guest name boxes.'); postHeight(); return; }
      selectedAttendees = names.slice(0,parseInt(sel.value,10)).map(titleCaseName);
      showStep('transport');
    });

    // Transport
    transportBack.addEventListener('click', ()=> showStep('attendance'));
    transportNext.addEventListener('click', function(){ const v=(transportSelect.value||'').trim(); if(!v){ setError(attendeeError,'Please choose Yes or No for airport transfer.'); postHeight(); return; } selectedTransport = v==='Yes'?'Yes':'No'; setError(attendeeError,''); showStep('phone'); });

    // Phone
    phoneInput.addEventListener('input', ()=> { phoneInput.value = formatPhoneInput(phoneInput.value); postHeight(); });
    phoneBack.addEventListener('click', ()=> showStep('transport'));
    phoneNext.addEventListener('click', function(){ setError(phoneErr,''); if(selectedStatus==='Attending'){ const s = normalizePhoneToStored(phoneInput.value); if(!s){ setError(phoneErr,'Phone must be 11 digits starting with 09 (e.g. 0917 123 4567)'); postHeight(); return; } selectedPhoneStored = s; } else selectedPhoneStored=''; showStep('notes'); });

    // Notes
    notesBack.addEventListener('click', ()=> showStep('phone'));
    notesNext.addEventListener('click', ()=> { selectedNotes = (notesInput.value||'').trim(); buildReview(); showStep('review'); });

    // Review
    reviewBack.addEventListener('click', ()=> showStep('attendance'));
    function buildReview(){
      const statusText = selectedStatus === 'Attending' ? 'ATTENDING' : 'DECLINED';
      let html = "<div style='font-weight:700'>"+escapeHtml(currentInvite.display_name)+"</div>";
      html += "<div style='margin-top:0.4rem;font-weight:600'>"+statusText+"</div>";
      if(selectedStatus === 'Attending'){
        if(currentMaxSeats > 1){
          html += "<div style='margin-top:.5rem'><strong>Guest names:</strong><ul style='list-style:none;padding:0;margin:8px 0'>";
          selectedAttendees.forEach(n=> html += "<li>"+escapeHtml(n)+"</li>");
          html += "</ul></div>";
        }
        html += "<div style='margin-top:0.25rem'><strong>Airport transfer:</strong> "+escapeHtml(selectedTransport)+"</div>";
        html += "<div style='margin-top:0.25rem'><strong>Phone:</strong> "+escapeHtml(selectedPhoneStored)+"</div>";
      }
      if(selectedNotes) html += "<div style='margin-top:0.4rem'><strong>Notes:</strong> "+escapeHtml(selectedNotes)+"</div>";
      reviewSummary.innerHTML = html;
      reviewError.style.display = 'none';
      postHeight();
    }

    // Submit
    submitBtn.addEventListener('click', async function(){
      reviewError.style.display = 'none';
      const payload = { action:'submit', invite_id: currentInvite.invite_id, status:selectedStatus, attending_count:(selectedStatus==='Attending'?(currentMaxSeats<=1?1:Math.min(selectedAttendees.length,currentMaxSeats)):0), attendees:(selectedStatus==='Attending'?(currentMaxSeats<=1?[ titleCaseName(currentInvite.display_name) ]:selectedAttendees.slice(0,currentMaxSeats)):[]), phone:(selectedStatus==='Attending'?selectedPhoneStored:''), transportation:(selectedStatus==='Attending'?selectedTransport:''), notes:selectedNotes||'' };
      submitBtn.disabled = true;
      const r = await jsonFetch(payload);
      submitBtn.disabled = false;
      if(!r || !r.ok){ reviewError.textContent = (r && r.error) ? r.error : 'Server error'; reviewError.style.display = ''; postHeight(); return; }
      if(r.locked){ reviewError.textContent = "This invitation has already been responded to."; reviewError.style.display = ''; postHeight(); return; }
      if(selectedStatus === 'Attending') thanksMessage.innerHTML = "<strong>See you there — we're excited to celebrate with you!</strong><div class='small' style='margin-top:.4rem'>If you need to make changes, contact us: +1 778 977 4975 (WhatsApp/Viber)</div>";
      else thanksMessage.innerHTML = "<strong>We're sorry you can't join us.</strong><div class='small' style='margin-top:.4rem'>If you need to make changes, contact us: +1 778 977 4975 (WhatsApp/Viber)</div>";
      notifyParentHasBottomClose('thanks', true);
      showStep('thanks');
    });

    if (thanksClose) thanksClose.addEventListener('click', function(){ try{ window.parent.postMessage({ type:'RSVP:CLOSE' }, '*'); }catch(_){} try{ window.close(); }catch(_){} });
    if (notInListClose) notInListClose.addEventListener('click', function(){ try{ window.parent.postMessage({ type:'RSVP:CLOSE' }, '*'); }catch(_){} try{ window.close(); }catch(_){} });

    findBtn.addEventListener('click', doFind);
    nameInput.addEventListener('keydown', function(e){ if(e.key === 'Enter'){ e.preventDefault(); doFind(); } });

    window.addEventListener('load', function(){ setTimeout(postHeight, 60); });
    try { var mo = new MutationObserver(function(){ postHeight(); }); mo.observe(document.body, { childList:true, subtree:true, attributes:true, characterData:true }); } catch(e){}
    try { var ro = new ResizeObserver(function(){ postHeight(); }); ro.observe(document.documentElement); } catch(e){}
    setInterval(postHeight, 1200);

    window.addEventListener('message', function (e) { try { if (e && e.data && e.data.type === 'RSVP:REQUEST_HEIGHT') postHeight(); } catch (_) {} });

    function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;'); }

    showStep('search');
    try { nameInput.focus(); } catch(_) {}

  })();
  </script>
</body>
</html>
