<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mars + Bianca — RSVP</title>

  <script>try{ if(window.self !== window.top) document.documentElement.setAttribute('data-embedded','true'); }catch(e){} </script>

  <style>
    :root { --bg:#fff; --muted:#666; --accent:#222; --card-radius:0.6rem; --content-max:42rem; }
    html,body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;color:#111;background:var(--bg);height:auto;}
    .page-wrap{display:flex;align-items:center;justify-content:center;padding:3.5vw 2vw;}
    .app-box{width:100%;max-width:var(--content-max);background:#fff;border-radius:var(--card-radius);box-shadow:0 0.5rem 1.5rem rgba(0,0,0,0.12);padding:0.9rem;box-sizing:border-box;margin:0 auto;}
    :root[data-embedded="true"] .app-box{background:transparent;box-shadow:none;border-radius:0;padding:0.7rem;max-width:100%;}
    .content-column{max-width:40rem;margin:0 auto;text-align:center;padding:0.4rem 0.6rem;}
    .step{display:none}
    .step.active{display:block}
    /* ... rest of your styles unchanged ... */
  </style>
</head>
<body>
  <div class="page-wrap">
    <div class="app-box" id="appBox" role="dialog" aria-modal="true">
      <div id="loading" class="loading-overlay" style="display:none"><div class="spinner" aria-hidden="true"></div></div>

      <div class="content-column">
        <h1>Mars + Bianca</h1>
        <div class="subhead">Nuuk Taal<br>October 15, 2027</div>

        <!-- Steps (same structure as you had earlier) -->
        <div id="step-search" class="step active">
          <span class="prompt">Please enter the name shown on your invitation to find your RSVP record.</span>
          <div class="search-row"><input id="nameInput" placeholder="Type your name" autocomplete="name" /></div>
          <div id="searchErr" class="error" aria-live="polite"></div>
          <div class="actions"><div class="actions-right"><button id="findBtn" class="btn primary">Find</button></div></div>
        </div>

        <div id="step-matches" class="step">
          <span class="prompt">We found matching names — please select your name below to continue.</span>
          <div id="matches" class="matches" aria-live="polite"></div>
          <div class="actions">
            <button id="dontSeeBtn" class="btn ghost">I don't see my name</button>
            <div class="actions-right"><button id="backToSearch" class="btn ghost">Back</button></div>
          </div>
        </div>

        <div id="step-attendance" class="step">
          <span class="prompt">Please tell us whether you will join us for the celebration.</span>
          <div class="form-row">
            <label for="attendanceSelect">Will you be joining us?</label>
            <select id="attendanceSelect"><option value="">-- choose --</option><option value="Attending">Yes — I/we will attend</option><option value="Declined">Regretfully decline</option></select>
          </div>
          <div id="attendanceDynamic" style="margin-top:.4rem"></div>
          <div id="attendeeError" class="error"></div>
          <div class="actions">
            <button id="attendanceBack" class="btn ghost">Back</button>
            <div class="actions-right"><button id="attendanceNext" class="btn primary">Next</button></div>
          </div>
        </div>

        <!-- ... other steps identical to your original layout ... -->

        <div id="step-thanks" class="step">
          <span class="prompt">Thank you — your response is recorded.</span>
          <div id="thanksMessage" class="message" style="text-align:center"></div>
          <div class="actions">
            <div class="actions-right"><button id="thanksClose" class="btn primary">Close</button></div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <script>
  (function () {
    const API_URL = "https://rsvp-proxy.marsnbianca.workers.dev/"; // <-- replace with your Worker URL

    const steps = {
      search: document.getElementById('step-search'),
      matches: document.getElementById('step-matches'),
      attendance: document.getElementById('step-attendance'),
      // ... other step refs ...
      thanks: document.getElementById('step-thanks')
    };

    // basic refs used in your flow (you can keep the rest of your logic as before)
    const nameInput = document.getElementById('nameInput');
    const findBtn = document.getElementById('findBtn');

    // showStep implementation now posts step and height after layout settles
    function showStep(name) {
      Object.values(steps).forEach(s => { if (s) s.classList.remove('active'); });
      if (steps[name]) steps[name].classList.add('active');

      // focus first control
      setTimeout(()=> { try { const first = steps[name].querySelector('input,select,button,textarea'); if(first) first.focus(); } catch(_){} }, 40);

      // after layout settles, post both step and height so parent can size iframe exactly
      postStepAndHeightDebounced(name);
    }

    // send step and measured height to parent (debounced)
    var stepTimer = null;
    function postStepAndHeightDebounced(stepName) {
      if (stepTimer) clearTimeout(stepTimer);
      stepTimer = setTimeout(function () {
        postStepAndHeight(stepName);
      }, 80);
    }

    function postStepAndHeight(stepName) {
      try {
        const h = Math.max(document.documentElement.scrollHeight || 0, document.body.scrollHeight || 0);
        window.parent.postMessage({ type:'RSVP:STEP', step: stepName }, '*');
        window.parent.postMessage({ type:'RSVP:HEIGHT', height: Math.round(h), step: stepName }, '*');
      } catch (e) { /* ignore */ }
    }

    // Example wiring for the "Find" button -> show matches (replace with your real logic)
    if (findBtn) {
      findBtn.addEventListener('click', function () {
        // ... your find logic here ...
        // For demo: show matches
        showStep('matches');
      });
    }

    // When DOM updates (mutation / resize), re-post height for parent to resize
    try {
      var mo = new MutationObserver(function(){ 
        // find active step
        var active = Array.from(document.querySelectorAll('.step')).find(s => s.classList.contains('active'));
        if(active) postStepAndHeightDebounced(active.id.replace(/^step-/,''));
      });
      mo.observe(document.body, { childList:true, subtree:true, attributes:true, characterData:true });
    } catch(e){}

    try {
      var ro = new ResizeObserver(function(){ 
        var active = Array.from(document.querySelectorAll('.step')).find(s => s.classList.contains('active'));
        if(active) postStepAndHeightDebounced(active.id.replace(/^step-/,''));
      });
      ro.observe(document.documentElement);
    } catch(e){}

    // reply to parent requests
    window.addEventListener('message', function (e) {
      try {
        if (e && e.data && e.data.type === 'RSVP:REQUEST_HEIGHT') {
          var active = Array.from(document.querySelectorAll('.step')).find(s => s.classList.contains('active'));
          var stepName = active ? active.id.replace(/^step-/,'') : 'search';
          postStepAndHeight(stepName);
        }
        if (e && e.data && e.data.type === 'RSVP:REQUEST_STEP') {
          var active = Array.from(document.querySelectorAll('.step')).find(s => s.classList.contains('active'));
          var stepName = active ? active.id.replace(/^step-/,'') : 'search';
          try { window.parent.postMessage({ type:'RSVP:STEP', step: stepName }, '*'); } catch(_) {}
        }
      } catch(_) {}
    });

    // initialize
    showStep('search');

  })();
  </script>
</body>
</html>
