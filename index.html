<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RSVP — Mars & Bianca</title>
  <style>
    :root{
      --bg:#ffffff;
      --muted:#666;
      --accent:#222;
      --danger:#c0392b;
      --card-radius:12px;
      --max-width:820px;
    }
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;color:#111;background:var(--bg);}
    .page-wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:4vw 2vw;}
    .app-box{
      width:100%;
      max-width:var(--max-width);
      background:#fff;
      border-radius:var(--card-radius);
      box-shadow:0 10px 30px rgba(0,0,0,0.12);
      padding:1.25rem;
      box-sizing:border-box;
      position:relative;
    }

    h2{margin:0 0 .5rem;font-size:clamp(1.05rem,2.6vw,1.4rem)}
    .search-row{display:flex;gap:.5rem;margin-bottom:.75rem}
    .search-row input{flex:1;padding:.6rem;border:1px solid #e5e5e5;border-radius:8px;font-size:1rem}
    .search-row button{padding:.6rem .9rem;border-radius:8px;border:0;background:var(--accent);color:#fff;cursor:pointer}
    .matches{margin-bottom:1rem}
    .matches-subtext{font-size:.95rem;color:var(--muted);margin-bottom:.5rem}
    .match-btn{display:flex;align-items:center;justify-content:space-between;padding:.7rem;border:1px solid #f0f0f0;border-radius:8px;margin:.45rem 0;background:#fff;cursor:pointer;transition:all .12s}
    .match-btn:hover{background:#fafafa;transform:translateY(-2px)}
    .match-btn:active{opacity:.95}
    .message{padding:.6rem;background:#e7f7e7;border:1px solid #bfe6bf;border-radius:8px;margin:.5rem 0}
    .error{padding:.6rem;background:#ffecec;border:1px solid #f5c2c2;border-radius:8px;margin:.5rem 0;color:var(--danger);display:none}

    .step{display:none}
    .step.active{display:block}

    .form-row{display:flex;flex-direction:column;gap:.35rem;margin-bottom:.5rem}
    label{font-size:.95rem;color:#333}
    input,select,textarea{padding:.6rem;font-size:1rem;border:1px solid #e6e6e6;border-radius:8px;width:100%;box-sizing:border-box}
    textarea{min-height:80px;resize:vertical}

    .actions{display:flex;gap:.6rem;margin-top:.6rem;justify-content:flex-end}
    .btn{padding:.6rem .9rem;border-radius:8px;border:0;cursor:pointer}
    .btn.primary{background:var(--accent);color:#fff}
    .btn.ghost{background:#f3f3f3;color:#111}
    .btn.text{background:transparent;color:var(--accent)}
    .small{font-size:.92rem;color:var(--muted)}

    /* Loading overlay */
    .loading-overlay{position:absolute;inset:0;display:none;align-items:center;justify-content:center;background:rgba(255,255,255,0.7);border-radius:inherit;z-index:999}
    .spinner{width:36px;height:36px;border-radius:50%;border:4px solid #eee;border-top-color:var(--accent);animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* small responsive tweaks */
    @media (max-width:540px){
      .app-box{padding:12px;border-radius:10px}
      .match-btn{padding:.6rem}
    }
    /* phone input monospace so formatting looks neat */
    input[type=tel]{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Courier New", monospace}
  </style>
</head>
<body>
  <div class="page-wrap">
    <div class="app-box" id="appBox" role="dialog" aria-modal="true">
      <div id="loading" class="loading-overlay"><div class="spinner" aria-hidden="true"></div></div>

      <h2 id="title">RSVP — Mars & Bianca</h2>

      <!-- Step: Search -->
      <div id="step-search" class="step active">
        <div class="search-row">
          <input id="nameInput" placeholder="Type your name" autocomplete="name" />
          <button id="findBtn" type="button">Find</button>
        </div>
        <div id="searchErr" class="error"></div>
      </div>

      <!-- Step: Matches -->
      <div id="step-matches" class="step">
        <div class="matches-subtext">We found you in the guest list! Please select your name below to RSVP.</div>
        <div id="matches" class="matches" aria-live="polite"></div>
        <div style="margin-top:.6rem;display:flex;gap:.6rem;justify-content:space-between;align-items:center">
          <button id="dontSeeBtn" class="btn text">I don't see my name</button>
          <button id="backToSearch" class="btn ghost">Back</button>
        </div>
      </div>

      <!-- Step: Not-in-list / Contact -->
      <div id="step-not-in-list" class="step">
        <div class="message">
          <strong>Can't find your name?</strong>
          <div class="small" style="margin-top:.5rem">If you believe you should be on the guest list, please contact us and we'll check.</div>
          <div style="margin-top:.6rem"><strong>Contact:</strong> +1 778 977 4975 (WhatsApp / Viber)</div>
        </div>
        <div class="actions">
          <button id="notInListBack" class="btn ghost">Back</button>
        </div>
      </div>

      <!-- Step: Attendance + Attendee names combined -->
      <div id="step-attendance" class="step">
        <div class="form-row">
          <label>Will you be joining us?</label>
          <select id="attendanceSelect">
            <option value="">-- choose --</option>
            <option value="Attending">Yes — I/we will attend</option>
            <option value="Declined">Regretfully decline</option>
          </select>
        </div>

        <div id="attendeeInputsContainer" style="margin-bottom:.6rem"></div>
        <div id="attendeeError" class="error"></div>

        <div class="actions">
          <button id="attendanceBack" class="btn ghost">Back</button>
          <button id="attendanceNext" class="btn primary">Next</button>
        </div>
      </div>

      <!-- Step: Transportation -->
      <div id="step-transport" class="step">
        <div class="form-row">
          <label>Do you need airport transfer from NAIA to Club Balai Isabel (Batangas)?</label>
          <select id="transportSelect">
            <option value="">-- choose --</option>
            <option value="Yes">Yes — I/We need airport transfer</option>
            <option value="No">No — we don't need airport transfer</option>
          </select>
        </div>

        <div class="actions">
          <button id="transportBack" class="btn ghost">Back</button>
          <button id="transportNext" class="btn primary">Next</button>
        </div>
      </div>

      <!-- Step: Phone -->
      <div id="step-phone" class="step">
        <div class="form-row">
          <label>Phone (PH format)</label>
          <input id="phoneInput" type="tel" placeholder="09" />
          <div id="phoneErr" class="error"></div>
        </div>

        <div class="actions">
          <button id="phoneBack" class="btn ghost">Back</button>
          <button id="phoneNext" class="btn primary">Next</button>
        </div>
      </div>

      <!-- Step: Notes -->
      <div id="step-notes" class="step">
        <div class="form-row">
          <label>Notes (optional — dietary, song requests, messages)</label>
          <textarea id="notesInput" placeholder="E.g. vegetarian, song request..."></textarea>
        </div>

        <div class="actions">
          <button id="notesBack" class="btn ghost">Back</button>
          <button id="notesNext" class="btn primary">Review</button>
        </div>
      </div>

      <!-- Step: Review & Submit -->
      <div id="step-review" class="step">
        <div id="reviewSummary" class="form-row"></div>
        <div id="statusLine" style="color:var(--danger);font-weight:600;margin-bottom:.5rem"></div>
        <div id="reviewError" class="error"></div>

        <div class="actions">
          <button id="reviewBack" class="btn ghost">Back</button>
          <button id="submitBtn" class="btn primary">Submit RSVP</button>
        </div>
      </div>

      <!-- Step: Thank you -->
      <div id="step-thanks" class="step">
        <div id="thanksMessage" class="message"></div>
        <div style="margin-top:.7rem;display:flex;justify-content:center">
          <button id="thanksClose" class="btn primary">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script>
  (function () {
    // CONFIG — set to your Cloudflare Worker URL (proxy)
    const API_URL = "https://rsvp-proxy.marsnbianca.workers.dev/"; // <-- replace with your Worker URL

    // Step elements
    const steps = {
      search: document.getElementById('step-search'),
      matches: document.getElementById('step-matches'),
      notInList: document.getElementById('step-not-in-list'),
      attendance: document.getElementById('step-attendance'),
      transport: document.getElementById('step-transport'),
      phone: document.getElementById('step-phone'),
      notes: document.getElementById('step-notes'),
      review: document.getElementById('step-review'),
      thanks: document.getElementById('step-thanks')
    };

    // Search / matches
    const nameInput = document.getElementById('nameInput');
    const findBtn = document.getElementById('findBtn');
    const searchErr = document.getElementById('searchErr');
    const matchesEl = document.getElementById('matches');
    const dontSeeBtn = document.getElementById('dontSeeBtn');
    const backToSearch = document.getElementById('backToSearch');

    // Attendance + attendees combined
    const attendanceSelect = document.getElementById('attendanceSelect');
    const attendeeInputsContainer = document.getElementById('attendeeInputsContainer');
    const attendeeError = document.getElementById('attendeeError');
    const attendanceBack = document.getElementById('attendanceBack');
    const attendanceNext = document.getElementById('attendanceNext');

    // Transport
    const transportSelect = document.getElementById('transportSelect');
    const transportBack = document.getElementById('transportBack');
    const transportNext = document.getElementById('transportNext');

    // Phone
    const phoneInput = document.getElementById('phoneInput');
    const phoneErr = document.getElementById('phoneErr');
    const phoneBack = document.getElementById('phoneBack');
    const phoneNext = document.getElementById('phoneNext');

    // Notes
    const notesInput = document.getElementById('notesInput');
    const notesBack = document.getElementById('notesBack');
    const notesNext = document.getElementById('notesNext');

    // Review / submit
    const reviewSummary = document.getElementById('reviewSummary');
    const reviewError = document.getElementById('reviewError');
    const statusLine = document.getElementById('statusLine');
    const reviewBack = document.getElementById('reviewBack');
    const submitBtn = document.getElementById('submitBtn');

    // Thanks
    const thanksMessage = document.getElementById('thanksMessage');
    const thanksClose = document.getElementById('thanksClose');

    // Not-in-list
    const notInListBack = document.getElementById('notInListBack');

    // Loading overlay
    const loadingOverlay = document.getElementById('loading');

    // State
    let currentInvite = null; // { invite_id, display_name, max_seats }
    let currentMaxSeats = 1;
    let selectedStatus = "";
    let selectedAttendees = [];
    let selectedTransport = "";
    let selectedPhoneStored = "";
    let selectedNotes = "";

    // Helpers
    function showStep(name){
      Object.values(steps).forEach(s=>s.classList.remove('active'));
      if(steps[name]) steps[name].classList.add('active');
      try { document.getElementById('appBox').scrollTop = 0; } catch (_) {}
    }
    function setError(el, msg){
      if(!el) return;
      if(msg){ el.textContent = msg; el.style.display = ''; } else { el.textContent = ''; el.style.display = 'none'; }
    }
    function loading(on){
      loadingOverlay.style.display = on ? 'flex' : 'none';
    }

    async function jsonFetch(payload){
      loading(true);
      try {
        const res = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify(payload)
        });
        const txt = await res.text();
        try { return JSON.parse(txt); } catch(e) { return { ok:false, error:"Invalid server response" }; }
      } catch (err) {
        console.error("Network error", err);
        return { ok:false, error:"Network error" };
      } finally { loading(false); }
    }

    // Title case helper for names before submit
    function titleCaseName(s){
      s = String(s||'').replace(/\s+/g,' ').trim().toLowerCase();
      if(!s) return "";
      var out = "";
      var capNext = true;
      for(var i=0;i<s.length;i++){
        var ch = s[i];
        if(capNext && ch >= 'a' && ch <= 'z'){
          out += ch.toUpperCase(); capNext = false;
        } else {
          out += ch;
        }
        if(ch === ' ' || ch === '-' || ch === "'") capNext = true;
      }
      return out;
    }

    // Phone normalization/validation
    function formatPhoneInput(v){
      var digits = String(v||'').replace(/\D+/g,'');
      // handle +63 or leading 9 conversions not needed here, require user to start with 09
      if(digits.indexOf('63')===0 && digits.length>=12) digits = '0' + digits.slice(2);
      if(digits.indexOf('9')===0 && digits.length===10) digits = '0' + digits;
      digits = digits.slice(0,11);
      if(digits.length<=2) return digits;
      if(digits.length<=4) return digits.slice(0,4);
      if(digits.length<=7) return digits.slice(0,4) + ' ' + digits.slice(4);
      return digits.slice(0,4) + ' ' + digits.slice(4,7) + ' ' + digits.slice(7,11);
    }
    function normalizePhoneToStored(input){
      var digits = String(input || "").replace(/\D+/g, "");
      if(!digits) return "";
      if(digits.indexOf("63") === 0 && digits.length >= 12) digits = "0" + digits.slice(2);
      if(digits.indexOf("9") === 0 && digits.length === 10) digits = "0" + digits;
      digits = digits.slice(0, 11);
      if(!/^09\d{9}$/.test(digits)) return "";
      return digits.slice(0,4) + " " + digits.slice(4,7) + " " + digits.slice(7,11);
    }

    // Search flow
    async function doFind(){
      setError(searchErr,'');
      matchesEl.innerHTML = '';
      const q = (nameInput.value||'').trim();
      if(q.length < 3){
        setError(searchErr, 'Please type at least 3 characters.');
        return;
      }
      findBtn.disabled = true;
      const r = await jsonFetch({ action:'find', name: q, client_id: 'guest-'+Date.now() });
      findBtn.disabled = false;
      if(!r || !r.ok){ setError(searchErr, r && r.error ? r.error : 'Server error'); return; }
      if(!r.matches || r.matches.length === 0){
        matchesEl.innerHTML = "<div class='message'>No matches found.</div>";
        showStep('matches');
        return;
      }
      matchesEl.innerHTML = '';
      r.matches.forEach(m=>{
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'match-btn';
        btn.innerHTML = "<div><strong>"+escapeHtml(m.display_name)+"</strong></div>";
        btn.addEventListener('click', ()=> onSelectMatch(m.invite_id, m.display_name, m.max_seats));
        matchesEl.appendChild(btn);
      });
      showStep('matches');
    }

    // "I don't see my name"
    dontSeeBtn.addEventListener('click', function(){ showStep('notInList'); });
    backToSearch.addEventListener('click', function(){ showStep('search'); });

    // Not in list back
    notInListBack.addEventListener('click', function(){ showStep('matches'); });

    // When match selected
    async function onSelectMatch(invite_id, display_name, max_seats){
      // call get to see locked and canonical max_seats
      const r = await jsonFetch({ action:'get', invite_id: invite_id });
      if(!r || !r.ok){ alert(r && r.error ? r.error : 'Server error'); return; }
      if(r.locked){
        // replace matches with locked message and provide Close button
        matchesEl.innerHTML = "<div class='message'>This invitation has already been answered. If you need to make changes, please contact us: +1 778 977 4975 (WhatsApp/Viber)</div>";
        // show a close control in place of back: implement by showing the notInList screen with same message and a close button - but simpler: showMatches contains Close button
        // We'll add a Close button below
        const closeBtn = document.createElement('button');
        closeBtn.className = 'btn primary';
        closeBtn.style.marginTop = '10px';
        closeBtn.textContent = 'Close';
        closeBtn.addEventListener('click', function(){
          try { window.parent.postMessage('RSVP:CLOSE','*'); } catch(_) {}
          try { window.close(); } catch(_) {}
        });
        matchesEl.appendChild(closeBtn);
        return;
      }

      // set currentInvite
      currentInvite = { invite_id: invite_id, display_name: display_name, max_seats: Math.max(1, r.invite && r.invite.max_seats ? parseInt(r.invite.max_seats,10) : (max_seats || 1)) };
      currentMaxSeats = Math.min(currentInvite.max_seats, 4); // cap UI to 4
      // reset selections
      selectedStatus=''; selectedAttendees=[]; selectedTransport=''; selectedPhoneStored=''; selectedNotes='';

      // populate attendance screen
      attendanceSelect.value = '';
      attendeeInputsContainer.innerHTML = '';
      setError(attendeeError, '');
      // If max seats > 1, render inputs equal to max seats (no extra text)
      if(currentMaxSeats > 1){
        for(let i=0;i<currentMaxSeats;i++){
          const input = document.createElement('input');
          input.type = 'text';
          input.placeholder = 'Guest full name';
          input.className = 'guest-name-input';
          input.style.marginBottom = '8px';
          input.style.width = '100%';
          attendeeInputsContainer.appendChild(input);
        }
      }
      showStep('attendance');
    }

    // Attendance navigation
    attendanceBack.addEventListener('click', function(){ showStep('matches'); });
    attendanceNext.addEventListener('click', function(){
      setError(attendeeError,'');
      const val = (attendanceSelect.value||'').trim();
      if(!val){ setError(attendeeError, 'Please choose whether you will attend or decline.'); return; }
      selectedStatus = val;
      if(selectedStatus === 'Declined'){
        // clear attendee inputs
        selectedAttendees = [];
        showStep('transport');
        return;
      }
      // Attending
      if(currentMaxSeats <= 1){
        // single invite: use invite display name automatically
        selectedAttendees = [ titleCaseName(currentInvite.display_name) ];
        showStep('transport');
        return;
      }
      // multiple seats: collect names from inputs if any prefilled (do not require all now, require at least one)
      const inputs = Array.from(attendeeInputsContainer.querySelectorAll('.guest-name-input'));
      const names = inputs.map(i=>i.value.trim()).filter(Boolean);
      if(names.length < 1){
        setError(attendeeError, 'Please provide at least one attendee full name.');
        return;
      }
      selectedAttendees = names.map(titleCaseName).slice(0,currentMaxSeats);
      showStep('transport');
    });

    // Transport navigation
    transportBack.addEventListener('click', function(){
      showStep('attendance');
    });
    transportNext.addEventListener('click', function(){
      const v = (transportSelect.value||'').trim();
      if(!v){ setError(attendeeError, 'Please choose Yes or No for airport transfer.'); return; }
      setError(attendeeError,'');
      selectedTransport = v === 'Yes' ? 'Yes' : 'No';
      showStep('phone');
    });

    // Phone input formatting & validation
    phoneInput.addEventListener('input', function(e){
      const formatted = formatPhoneInput(phoneInput.value);
      phoneInput.value = formatted;
    });

    phoneBack.addEventListener('click', function(){ showStep('transport'); });
    phoneNext.addEventListener('click', function(){
      setError(phoneErr,'');
      if(selectedStatus === 'Attending'){
        const stored = normalizePhoneToStored(phoneInput.value);
        if(!stored){
          setError(phoneErr, 'Phone must be 11 digits starting with 09 (e.g. 0917 123 4567).');
          return;
        }
        selectedPhoneStored = stored;
      } else {
        selectedPhoneStored = '';
      }
      showStep('notes');
    });

    // Notes navigation
    notesBack.addEventListener('click', function(){
      showStep('phone');
    });
    notesNext.addEventListener('click', function(){
      selectedNotes = (notesInput.value||'').trim();
      buildReview();
      showStep('review');
    });

    // Review
    reviewBack.addEventListener('click', function(){ showStep('notes'); });

    function buildReview(){
      let html = "<div><strong>Invite:</strong> "+escapeHtml(currentInvite.display_name)+"</div>";
      html += "<div><strong>Response:</strong></div>";
      // show response in red under the label
      statusLine.textContent = selectedStatus === 'Attending' ? 'Attending' : 'Declined';
      if(selectedStatus === 'Attending') statusLine.style.color = '#1b9b4a'; else statusLine.style.color = 'var(--danger)';
      html += "<div style='margin-top:.4rem;'><strong>Attendees:</strong><ul>";
      if(selectedStatus === 'Attending'){
        if(currentMaxSeats <= 1){
          html += "<li>"+escapeHtml(titleCaseName(currentInvite.display_name))+"</li>";
        } else {
          selectedAttendees.forEach(n => html += "<li>"+escapeHtml(n)+"</li>");
        }
      } else {
        html += "<li>—</li>";
      }
      html += "</ul></div>";
      if(selectedStatus === 'Attending'){
        html += "<div><strong>Airport transfer:</strong> "+escapeHtml(selectedTransport)+"</div>";
        html += "<div><strong>Phone:</strong> "+escapeHtml(selectedPhoneStored)+"</div>";
      }
      if(selectedNotes) html += "<div><strong>Notes:</strong> "+escapeHtml(selectedNotes)+"</div>";
      reviewSummary.innerHTML = html;
      reviewError.style.display = 'none';
    }

    submitBtn.addEventListener('click', async function(){
      reviewError.style.display = 'none';
      // prepare payload
      const payload = {
        action: 'submit',
        invite_id: currentInvite.invite_id,
        status: selectedStatus,
        attending_count: (selectedStatus==='Attending' ? (currentMaxSeats<=1 ? 1 : Math.min(selectedAttendees.length, currentMaxSeats)) : 0),
        attendees: (selectedStatus==='Attending' ? (currentMaxSeats<=1 ? [ titleCaseName(currentInvite.display_name) ] : selectedAttendees.slice(0,currentMaxSeats)) : []),
        phone: (selectedStatus==='Attending' ? selectedPhoneStored : ""),
        transportation: (selectedStatus==='Attending' ? selectedTransport : ""),
        notes: selectedNotes || ""
      };
      submitBtn.disabled = true;
      const r = await jsonFetch(payload);
      submitBtn.disabled = false;
      if(!r || !r.ok){
        reviewError.textContent = (r && r.error) ? r.error : 'Server error';
        reviewError.style.display = '';
        return;
      }
      if(r.locked){
        reviewError.textContent = "This invitation has already been responded to. If you need to change it please contact us: +1 778 977 4975 (WhatsApp/Viber)";
        reviewError.style.display = '';
        return;
      }
      // success -> thanks
      if(selectedStatus === 'Attending'){
        thanksMessage.innerHTML = "<strong>See you there — we're excited to celebrate with you!</strong><div class='small' style='margin-top:.5rem'>If you need to make changes, contact us: +1 778 977 4975 (WhatsApp/Viber)</div>";
      } else {
        thanksMessage.innerHTML = "<strong>We're sorry you can't join us.</strong><div class='small' style='margin-top:.5rem'>If you need to make changes, contact us: +1 778 977 4975 (WhatsApp/Viber)</div>";
      }
      showStep('thanks');
    });

    // thanks close
    thanksClose.addEventListener('click', function(){
      try { window.parent.postMessage('RSVP:CLOSE','*'); } catch(_) {}
      try { if(window.opener && !window.opener.closed) window.opener.postMessage('RSVP:CLOSE','*'); } catch(_) {}
      try { window.close(); } catch(_) {}
    });

    // keyboard: Enter triggers search
    nameInput.addEventListener('keydown', function(e){
      if(e.key === 'Enter'){ e.preventDefault(); doFind(); }
    });
    findBtn.addEventListener('click', doFind);

    // small helpers
    function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    // init
    showStep('search');
    nameInput.focus();
  })();
  </script>
</body>
</html>
