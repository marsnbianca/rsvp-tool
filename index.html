<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RSVP — Mars & Bianca</title>
  <style>
    :root{
      --bg:#ffffff;
      --muted:#666;
      --accent:#222;
      --card-radius:12px;
      --max-width:820px;
    }
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;color:#111;background:var(--bg);}
    .page-wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:4vw 2vw;}
    .app-box{
      width:100%;
      max-width:var(--max-width);
      background:#fff;
      border-radius:var(--card-radius);
      box-shadow:0 10px 30px rgba(0,0,0,0.12);
      padding:1.25rem;
      box-sizing:border-box;
      position:relative;
    }

    h2{margin:0 0 .5rem;font-size:clamp(1.05rem,2.6vw,1.4rem)}
    .search-row{display:flex;gap:.5rem;margin-bottom:.75rem}
    .search-row input{flex:1;padding:.6rem;border:1px solid #e5e5e5;border-radius:8px;font-size:1rem}
    .search-row button{padding:.6rem .9rem;border-radius:8px;border:0;background:var(--accent);color:#fff;cursor:pointer}
    .matches{margin-bottom:1rem}
    .match-btn{display:flex;align-items:center;justify-content:space-between;padding:.7rem;border:1px solid #f0f0f0;border-radius:8px;margin:.45rem 0;background:#fff;cursor:pointer}
    .match-btn:hover{background:#fafafa;transform:translateY(-1px)}
    .match-btn:active{opacity:.9;transform:translateY(0)}
    .match-btn strong{font-weight:600}
    .message{padding:.6rem;background:#e7f7e7;border:1px solid #bfe6bf;border-radius:8px;margin:.5rem 0}
    .error{padding:.6rem;background:#ffecec;border:1px solid #f5c2c2;border-radius:8px;margin:.5rem 0;color:#800}

    .step{display:none}
    .step.active{display:block}

    .form-row{display:flex;flex-direction:column;gap:.35rem;margin-bottom:.5rem}
    label{font-size:.95rem;color:#333}
    input,select,textarea{padding:.6rem;font-size:1rem;border:1px solid #e6e6e6;border-radius:8px;width:100%;box-sizing:border-box}
    textarea{min-height:80px;resize:vertical}

    .actions{display:flex;gap:.6rem;margin-top:.6rem;justify-content:flex-end}
    .btn{padding:.6rem .9rem;border-radius:8px;border:0;cursor:pointer}
    .btn.primary{background:var(--accent);color:#fff}
    .btn.ghost{background:#f4f4f4;color:#111}
    .btn.text{background:transparent;color:var(--accent)}

    .small{font-size:.92rem;color:var(--muted)}

    /* Loading overlay */
    .loading-overlay{position:absolute;inset:0;display:none;align-items:center;justify-content:center;background:rgba(255,255,255,0.7);border-radius:inherit;z-index:999}
    .spinner{width:36px;height:36px;border-radius:50%;border:4px solid #eee;border-top-color:var(--accent);animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* responsive */
    @media (max-width:540px){
      .app-box{padding:12px;border-radius:10px}
      .match-btn{padding:.6rem}
    }
  </style>
</head>
<body>
  <div class="page-wrap">
    <div class="app-box" id="appBox" role="dialog" aria-modal="true">
      <div id="loading" class="loading-overlay"><div class="spinner" aria-hidden="true"></div></div>

      <h2 id="title">RSVP — Mars & Bianca</h2>

      <!-- Step: Search -->
      <div id="step-search" class="step active">
        <div class="search-row">
          <input id="nameInput" placeholder="Type your name (min 3 characters)" autocomplete="name" />
          <button id="findBtn" type="button">Find</button>
        </div>
        <div id="searchErr" class="error" style="display:none"></div>
        <div class="small">Tip: type at least 3 characters (family or first name).</div>
      </div>

      <!-- Step: Matches -->
      <div id="step-matches" class="step">
        <div id="matches" class="matches" aria-live="polite"></div>
        <div class="actions">
          <button id="backToSearch" class="btn ghost">Back</button>
        </div>
      </div>

      <!-- Step: Attendance -->
      <div id="step-attendance" class="step">
        <div id="inviteHeader" class="form-row">
          <strong id="inviteDisplayName"></strong>
          <div class="small" id="inviteSeatsInfo"></div>
        </div>

        <div class="form-row">
          <label>Will you be attending?</label>
          <select id="attendanceSelect">
            <option value="">-- choose --</option>
            <option value="Attending">Yes, I/we will attend</option>
            <option value="Declined">Regretfully decline</option>
          </select>
        </div>

        <div class="actions">
          <button id="attendanceBack" class="btn ghost">Back</button>
          <button id="attendanceNext" class="btn primary">Next</button>
        </div>
      </div>

      <!-- Step: Attendees names (if applicable) -->
      <div id="step-attendees" class="step">
        <div class="form-row">
          <label>Attendee full names (one per box) — enter up to <span id="attendeeCountLabel">1</span></label>
          <div id="attendeeInputs"></div>
        </div>

        <div class="form-row small">Names will be saved in Title Case.</div>

        <div class="actions">
          <button id="attendeesBack" class="btn ghost">Back</button>
          <button id="attendeesNext" class="btn primary">Next</button>
        </div>
      </div>

      <!-- Step: Transportation -->
      <div id="step-transport" class="step">
        <div class="form-row">
          <label>Do you need airport transfer from NAIA to Club Balai Isabel (Batangas)?</label>
          <select id="transportSelect">
            <option value="">-- choose --</option>
            <option value="Yes">Yes, I/We need airport transfer</option>
            <option value="No">No, thank you</option>
          </select>
        </div>

        <div class="actions">
          <button id="transportBack" class="btn ghost">Back</button>
          <button id="transportNext" class="btn primary">Next</button>
        </div>
      </div>

      <!-- Step: Phone -->
      <div id="step-phone" class="step">
        <div class="form-row">
          <label>Phone (PH format: 09XX XXX XXXX)</label>
          <input id="phoneInput" type="tel" placeholder="09XX XXX XXXX" />
          <div class="small">We require a valid PH mobile number for confirmations.</div>
        </div>

        <div class="actions">
          <button id="phoneBack" class="btn ghost">Back</button>
          <button id="phoneNext" class="btn primary">Next</button>
        </div>
      </div>

      <!-- Step: Notes -->
      <div id="step-notes" class="step">
        <div class="form-row">
          <label>Notes (optional — dietary restrictions, song requests, messages)</label>
          <textarea id="notesInput" placeholder="E.g. vegetarian, needs wheelchair access, song: ..."></textarea>
        </div>

        <div class="actions">
          <button id="notesBack" class="btn ghost">Back</button>
          <button id="notesNext" class="btn primary">Review & Submit</button>
        </div>
      </div>

      <!-- Step: Review & Submit -->
      <div id="step-review" class="step">
        <div id="reviewSummary" class="form-row"></div>

        <div id="reviewError" class="error" style="display:none"></div>

        <div class="actions">
          <button id="reviewBack" class="btn ghost">Back</button>
          <button id="submitBtn" class="btn primary">Submit RSVP</button>
        </div>
      </div>

      <!-- Step: Thank you -->
      <div id="step-thanks" class="step">
        <div class="message">
          <strong>Thanks — your RSVP has been recorded.</strong>
          <div class="small">If you need to change your RSVP, please contact us: +1 778 977 4975 (WhatsApp/Viber)</div>
        </div>
      </div>
    </div>
  </div>

  <script>
  (function () {
    // CONFIG — set to your Cloudflare Worker URL (proxy)
    const API_URL = "https://rsvp-proxy.marsnbianca.workers.dev/"; // <-- replace with your Worker URL

    // Elements
    const steps = {
      search: document.getElementById('step-search'),
      matches: document.getElementById('step-matches'),
      attendance: document.getElementById('step-attendance'),
      attendees: document.getElementById('step-attendees'),
      transport: document.getElementById('step-transport'),
      phone: document.getElementById('step-phone'),
      notes: document.getElementById('step-notes'),
      review: document.getElementById('step-review'),
      thanks: document.getElementById('step-thanks')
    };

    const nameInput = document.getElementById('nameInput');
    const findBtn = document.getElementById('findBtn');
    const searchErr = document.getElementById('searchErr');
    const matchesEl = document.getElementById('matches');

    const inviteDisplayName = document.getElementById('inviteDisplayName');
    const inviteSeatsInfo = document.getElementById('inviteSeatsInfo');
    const attendanceSelect = document.getElementById('attendanceSelect');

    const attendeeCountLabel = document.getElementById('attendeeCountLabel');
    const attendeeInputs = document.getElementById('attendeeInputs');

    const transportSelect = document.getElementById('transportSelect');
    const phoneInput = document.getElementById('phoneInput');
    const notesInput = document.getElementById('notesInput');

    const reviewSummary = document.getElementById('reviewSummary');
    const reviewError = document.getElementById('reviewError');

    const loadingOverlay = document.getElementById('loading');

    // buttons
    const backToSearch = document.getElementById('backToSearch');
    const attendanceNext = document.getElementById('attendanceNext');
    const attendanceBack = document.getElementById('attendanceBack');

    const attendeesNext = document.getElementById('attendeesNext');
    const attendeesBack = document.getElementById('attendeesBack');

    const transportNext = document.getElementById('transportNext');
    const transportBack = document.getElementById('transportBack');

    const phoneNext = document.getElementById('phoneNext');
    const phoneBack = document.getElementById('phoneBack');

    const notesNext = document.getElementById('notesNext');
    const notesBack = document.getElementById('notesBack');

    const submitBtn = document.getElementById('submitBtn');
    const reviewBack = document.getElementById('reviewBack');

    // state
    let currentInvite = null; // { invite_id, display_name, max_seats }
    let currentMaxSeats = 1;
    let selectedStatus = "";
    let selectedAttendees = [];
    let selectedTransport = "";
    let selectedPhoneStored = "";
    let selectedNotes = "";

    // helpers
    function showStep(step){
      Object.values(steps).forEach(s=>s.classList.remove('active'));
      steps[step].classList.add('active');
      // scroll to top of modal content for smaller screens
      try { document.getElementById('appBox').scrollTop = 0; } catch(_) {}
    }

    function loading(on){
      loadingOverlay.style.display = on ? 'flex' : 'none';
    }

    async function jsonFetch(payload){
      loading(true);
      try {
        const res = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify(payload)
        });
        const txt = await res.text();
        try { return JSON.parse(txt); } catch (e) { return { ok:false, error:"Invalid server response" }; }
      } catch (err) {
        console.error("Network error", err);
        return { ok:false, error:"Network error" };
      } finally { loading(false); }
    }

    // Title case helper
    function titleCase(s){
      s = String(s||"").replace(/\s+/g,' ').trim().toLowerCase();
      if(!s) return "";
      return s.split(/([\s\-'])/).map(function(part){
        if(/[\s\-']/.test(part)) return part;
        return part.charAt(0).toUpperCase() + part.slice(1);
      }).join('');
    }

    // Phone normalization similar to server:
    function normalizePhoneToStored(input){
      if(!input) return "";
      var digits = String(input||"").replace(/\D+/g,'');
      if(!digits) return "";
      if(digits.indexOf("63")===0 && digits.length>=12) digits = "0"+digits.slice(2);
      if(digits.indexOf("9")===0 && digits.length===10) digits = "0"+digits;
      digits = digits.slice(0,11);
      if(!/^09\d{9}$/.test(digits)) return "";
      return digits.slice(0,4)+" "+digits.slice(4,7)+" "+digits.slice(7,11);
    }

    // Step: Search
    async function doFind(){
      searchErr.style.display = 'none';
      matchesEl.innerHTML = "";
      const q = (nameInput.value||"").trim();
      if(q.length < 3){ searchErr.textContent = "Please type at least 3 characters."; searchErr.style.display = ""; return; }
      findBtn.disabled = true;
      const r = await jsonFetch({ action:'find', name: q, client_id: 'guest-'+Date.now() });
      findBtn.disabled = false;
      if(!r || !r.ok){ searchErr.textContent = r && r.error ? r.error : "Server error"; searchErr.style.display = ""; return; }
      if(!r.matches || r.matches.length===0){ matchesEl.innerHTML = "<div class='message'>No matches found.</div>"; showStep('matches'); return; }
      // build match buttons (names only)
      r.matches.forEach(m=>{
        const b = document.createElement('button');
        b.type = "button";
        b.className = "match-btn";
        b.innerHTML = "<div><strong>"+escapeHtml(m.display_name)+"</strong></div>";
        b.addEventListener('click', ()=>{ onSelectMatch(m.invite_id, m.display_name, m.max_seats); });
        matchesEl.appendChild(b);
      });
      showStep('matches');
    }

    backToSearch.addEventListener('click', function(){ showStep('search'); });

    async function onSelectMatch(invite_id, display_name, max_seats){
      // call API get to fetch locked status and max_seats canonical value
      const r = await jsonFetch({ action:'get', invite_id: invite_id });
      if(!r || !r.ok){ alert(r && r.error ? r.error : "Server error"); return; }
      if(r.locked){
        // show message and ask to contact
        matchesEl.innerHTML = "<div class='message'>This invitation has already been answered. If you need to make changes, please contact us: +1 778 977 4975 (WhatsApp/Viber)</div>";
        return;
      }
      currentInvite = { invite_id: invite_id, display_name: display_name, max_seats: Math.max(1, r.invite && r.invite.max_seats ? parseInt(r.invite.max_seats,10): (max_seats||1)) };
      currentMaxSeats = Math.min(currentInvite.max_seats, 4); // cap to 4
      // Reset selections
      selectedStatus = "";
      selectedAttendees = [];
      selectedTransport = "";
      selectedPhoneStored = "";
      selectedNotes = "";
      // populate attendance screen
      inviteDisplayName.textContent = currentInvite.display_name;
      inviteSeatsInfo.textContent = "Allowed seats: " + currentInvite.max_seats;
      attendanceSelect.value = "";
      showStep('attendance');
    }

    attendanceBack.addEventListener('click', ()=> showStep('matches'));
    attendanceNext.addEventListener('click', function(){
      const val = (attendanceSelect.value||"").trim();
      if(!val){ alert("Please choose whether you will attend or decline."); return; }
      selectedStatus = val;
      if(val === 'Declined'){
        // skip attendees, phone, transport -> go to notes then review
        selectedAttendees = [];
        showStep('notes');
        return;
      }
      // Attending: if max seats ==1 skip attendee inputs and proceed to transport
      if(currentMaxSeats <= 1){
        // single invite: we will treat attendee name as invite name automatically
        selectedAttendees = [ titleCase(currentInvite.display_name) ];
        showStep('transport');
        return;
      }
      // multiple seats: show attendee input screen
      buildAttendeeInputs(currentMaxSeats);
      showStep('attendees');
    });

    function buildAttendeeInputs(n){
      attendeeInputs.innerHTML = "";
      attendeeCountLabel.textContent = n;
      for(let i=0;i<n;i++){
        const div = document.createElement('div');
        div.style.marginBottom = '6px';
        const input = document.createElement('input');
        input.type = 'text';
        input.placeholder = (i===0? 'Primary attendee full name' : 'Guest full name');
        input.className = 'attendee-input';
        input.style.width = '100%';
        div.appendChild(input);
        attendeeInputs.appendChild(div);
      }
    }

    attendeesBack.addEventListener('click', ()=> showStep('attendance'));
    attendeesNext.addEventListener('click', function(){
      const inputs = Array.from(document.querySelectorAll('#attendeeInputs .attendee-input'));
      const names = inputs.map(i=>i.value.trim()).filter(Boolean).map(titleCase);
      if(names.length < 1){ alert("Please enter at least one attendee name."); return; }
      // ensure count not more than allowed
      if(names.length > currentMaxSeats) names.length = currentMaxSeats;
      selectedAttendees = names;
      showStep('transport');
    });

    transportBack.addEventListener('click', ()=> {
      if(currentMaxSeats>1) showStep('attendees'); else showStep('attendance');
    });
    transportNext.addEventListener('click', ()=>{
      const v = (transportSelect.value||"").trim();
      if(!v){ alert("Please choose Yes or No for airport transfer."); return; }
      selectedTransport = v === 'Yes' ? 'Yes' : 'No';
      showStep('phone');
    });

    phoneBack.addEventListener('click', ()=> showStep('transport'));
    phoneNext.addEventListener('click', ()=>{
      // if declined previously, should not be here; but ensure phone validation only if attending
      const phoneRaw = (phoneInput.value||"").trim();
      const phoneStored = normalizePhoneToStored(phoneRaw);
      if(selectedStatus === 'Attending'){
        if(!phoneStored){
          alert("Please enter a valid PH mobile number. Format: 09XX XXX XXXX");
          return;
        }
        selectedPhoneStored = phoneStored;
      } else {
        selectedPhoneStored = "";
      }
      showStep('notes');
    });

    notesBack.addEventListener('click', ()=> {
      if(selectedStatus==='Attending') showStep('phone'); else showStep('attendance');
    });
    notesNext.addEventListener('click', ()=> {
      selectedNotes = (notesInput.value||"").trim();
      buildReview();
      showStep('review');
    });

    reviewBack.addEventListener('click', ()=> showStep('notes'));

    function buildReview(){
      let html = "<div><strong>Invite:</strong> "+escapeHtml(currentInvite.display_name)+"</div>";
      html += "<div><strong>Status:</strong> "+escapeHtml(selectedStatus)+"</div>";
      if(selectedStatus==='Attending'){
        html += "<div><strong>Attendees:</strong><ul>";
        if(currentMaxSeats<=1){
          html += "<li>"+escapeHtml(currentInvite.display_name)+"</li>";
        } else {
          selectedAttendees.forEach(n=> html += "<li>"+escapeHtml(n)+"</li>");
        }
        html += "</ul></div>";
        html += "<div><strong>Airport transfer:</strong> "+escapeHtml(selectedTransport)+"</div>";
        html += "<div><strong>Phone:</strong> "+escapeHtml(selectedPhoneStored)+"</div>";
      }
      if(selectedNotes) html += "<div><strong>Notes:</strong> "+escapeHtml(selectedNotes)+"</div>";
      reviewSummary.innerHTML = html;
      reviewError.style.display = 'none';
    }

    submitBtn.addEventListener('click', async function(){
      reviewError.style.display = 'none';
      // prepare payload
      const payload = {
        action: 'submit',
        invite_id: currentInvite.invite_id,
        status: selectedStatus,
        attending_count: (selectedStatus==='Attending' ? (currentMaxSeats<=1 ? 1 : Math.min(selectedAttendees.length, currentMaxSeats)) : 0),
        attendees: (selectedStatus==='Attending' ? (currentMaxSeats<=1 ? [ titleCase(currentInvite.display_name) ] : selectedAttendees.slice(0,currentMaxSeats)) : []),
        phone: (selectedStatus==='Attending' ? selectedPhoneStored : ""),
        transportation: (selectedStatus==='Attending' ? selectedTransport : ""),
        notes: selectedNotes || ""
      };
      submitBtn.disabled = true;
      const r = await jsonFetch(payload);
      submitBtn.disabled = false;
      if(!r || !r.ok){
        reviewError.textContent = (r && r.error) ? r.error : "Server error";
        reviewError.style.display = '';
        return;
      }
      if(r.locked){
        reviewError.textContent = "This invitation has already been responded to. If you need to change it please contact us: +1 778 977 4975 (WhatsApp/Viber)";
        reviewError.style.display = '';
        return;
      }
      // success
      showStep('thanks');
    });

    // Enter key triggers search in name input
    nameInput.addEventListener('keydown', function(e){
      if(e.key === 'Enter'){
        e.preventDefault();
        doFind();
      }
    });

    // Escape from inside iframe does nothing (parent handles overlay close)

    // small helpers
    function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    // init
    showStep('search');
    nameInput.focus();
  })();
  </script>
</body>
</html>
