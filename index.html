<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RSVP — Mars & Bianca</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;padding:1rem;background:#fff;color:#111}
    .wrap{max-width:820px;margin:0 auto}
    .search{display:flex;gap:.5rem}
    input,textarea,select{width:100%;padding:.6rem;border:1px solid #ddd;border-radius:6px}
    button{padding:.6rem .9rem;border-radius:6px;background:#222;color:#fff;border:0}
    .match{display:flex;justify-content:space-between;align-items:center;padding:.5rem;border:1px solid #eee;border-radius:6px;margin:.5rem 0}
  </style>
</head>
<body>
  <div class="wrap">
    <h2>RSVP — Mars & Bianca</h2>
    <div class="search">
      <input id="name" placeholder="Type your name"/>
      <button id="find">Find</button>
    </div>
    <div id="matches"></div>

    <div id="invite" style="display:none">
      <h3 id="inviteName"></h3>
      <label>Status<select id="status"><option value="">--</option><option>Attending</option><option>Declined</option></select></label>
      <label>Attendees<textarea id="attendees" rows="3"></textarea></label>
      <label>Phone<input id="phone" type="text" /></label>
      <label>Notes<textarea id="notes" rows="2"></textarea></label>
      <div style="margin-top:.5rem"><button id="submit">Submit RSVP</button></div>
      <div id="msg" style="margin-top:.5rem"></div>
    </div>
  </div>

  <script>
    // CONFIG: set this to your Cloudflare Worker URL (not the Apps Script exec URL)
    const API_URL = "https://rsvp-proxy.marsnbianca.workers.dev/"; // <= replace

    function jsonFetch(payload) {
      return fetch(API_URL, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(payload)
      }).then(r=>r.json());
    }

    const nameInput = document.getElementById('name');
    const findBtn = document.getElementById('find');
    const matchesEl = document.getElementById('matches');
    const inviteEl = document.getElementById('invite');
    const inviteName = document.getElementById('inviteName');
    const status = document.getElementById('status');
    const attendees = document.getElementById('attendees');
    const phone = document.getElementById('phone');
    const notes = document.getElementById('notes');
    const submitBtn = document.getElementById('submit');
    const msg = document.getElementById('msg');

    findBtn.addEventListener('click', async () => {
      matchesEl.innerHTML = ''; msg.textContent='';
      const q = nameInput.value.trim(); if(!q){ msg.textContent='Type a name'; return; }
      findBtn.disabled=true;
      try {
        const r = await jsonFetch({action:'find', name:q, client_id:'guest-'+Date.now()});
        if(!r.ok){ msg.textContent = r.error || 'Server error'; return; }
        if(!r.matches || r.matches.length===0){ matchesEl.innerHTML = '<div>No matches</div>'; return; }
        r.matches.forEach(m=>{
          const d = document.createElement('div'); d.className='match';
          d.innerHTML = '<div><strong>'+encodeHTML(m.display_name)+'</strong><div style="font-size:.85rem;color:#666">invite: '+encodeHTML(m.invite_id)+'</div></div>';
          const b = document.createElement('button'); b.textContent = 'Select';
          b.addEventListener('click', ()=>selectInvite(m));
          d.appendChild(b); matchesEl.appendChild(d);
        });
      } catch (err) { console.error(err); msg.textContent='Network error'; }
      finally { findBtn.disabled=false; }
    });

    let currentInvite = null;
    async function selectInvite(m){
      try {
        const r = await jsonFetch({action:'get', invite_id:m.invite_id});
        if(!r.ok){ msg.textContent = r.error || 'Server error'; return; }
        currentInvite = r.invite || m;
        inviteName.textContent = currentInvite.display_name;
        inviteEl.style.display='block';
        status.value='';
        attendees.value='';
        phone.value='';
        notes.value='';
      } catch(e){ console.error(e); msg.textContent='Network error'; }
    }

    submitBtn.addEventListener('click', async ()=>{
      if(!currentInvite){ msg.textContent='No invite selected'; return; }
      const payload = {
        action:'submit',
        invite_id: currentInvite.invite_id,
        status: status.value,
        attending_count: (attendees.value.split('\n').filter(Boolean).length) || 1,
        attendees: attendees.value.split('\n').filter(Boolean),
        phone: phone.value.trim(),
        notes: notes.value.trim()
      };
      submitBtn.disabled=true;
      try {
        const r = await jsonFetch(payload);
        if(!r.ok){ msg.textContent = r.error || 'Server error'; return; }
        if(r.locked){ msg.textContent='This invite already responded'; return; }
        msg.textContent='Thanks — RSVP recorded';
        // optionally close overlay on parent page by postMessage if embedded
        try { window.parent.postMessage('RSVP:CLOSE','*'); } catch(_){}
      } catch(e){ console.error(e); msg.textContent='Network error'; }
      finally { submitBtn.disabled=false; }
    });

    function encodeHTML(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
  </script>
</body>
</html>
